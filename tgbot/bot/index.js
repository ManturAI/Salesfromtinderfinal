require('dotenv').config();
const TelegramBot = require('node-telegram-bot-api');

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
if (!process.env.BOT_TOKEN) {
  console.error('‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–∫–∞–∑–∞–Ω —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –≤ .env —Ñ–∞–π–ª–µ');
  console.log('üí° –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env –Ω–∞ –æ—Å–Ω–æ–≤–µ .env.example –∏ –¥–æ–±–∞–≤—å—Ç–µ BOT_TOKEN');
  process.exit(1);
}

if (!process.env.WEBAPP_URL) {
  console.error('‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–∫–∞–∑–∞–Ω URL –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ .env —Ñ–∞–π–ª–µ');
  console.log('üí° –î–æ–±–∞–≤—å—Ç–µ WEBAPP_URL –≤ —Ñ–∞–π–ª .env (–Ω–∞–ø—Ä–∏–º–µ—Ä: http://localhost:3000)');
  process.exit(1);
}

// –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –±–æ—Ç–∞
const bot = new TelegramBot(process.env.BOT_TOKEN, { 
  polling: {
    interval: 300,
    autoStart: true,
    params: {
      timeout: 10
    }
  }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ polling
bot.on('polling_error', (error) => {
  console.error('‚ùå –û—à–∏–±–∫–∞ polling:', error.message);
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ webhook
bot.on('webhook_error', (error) => {
  console.error('‚ùå –û—à–∏–±–∫–∞ webhook:', error.message);
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start
bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;
  const firstName = msg.from.first_name || '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
  const username = msg.from.username ? `@${msg.from.username}` : '';
  
  console.log(`üöÄ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${firstName} ${username} (ID: ${msg.from.id}) –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞`);
  
  // –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–æ–π –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  const keyboard = {
    reply_markup: {
      keyboard: [
        [{
          text: 'üåê –û—Ç–∫—Ä—ã—Ç—å –æ–±—É—á–∞—é—â—É—é –ø–ª–∞—Ç—Ñ–æ—Ä–º—É',
          web_app: { url: process.env.WEBAPP_URL }
        }],
        [
          { text: 'üìö –û –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ' },
          { text: '‚ùì –ü–æ–º–æ—â—å' }
        ]
      ],
      resize_keyboard: true,
      one_time_keyboard: false
    }
  };
  
  const welcomeMessage = `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${firstName}! üéâ

üéØ **Sales Training Platform** - –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –≤ –∏–∑—É—á–µ–Ω–∏–∏ —Ç–µ—Ö–Ω–∏–∫ –ø—Ä–æ–¥–∞–∂!

üìñ **–ß—Ç–æ –≤–∞—Å –∂–¥–µ—Ç:**
‚Ä¢ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —É—Ä–æ–∫–∏ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º
‚Ä¢ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∫–µ–π—Å—ã –∏ –ø—Ä–∏–º–µ—Ä—ã
‚Ä¢ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –æ–±—É—á–µ–Ω–∏—è
‚Ä¢ –ò–∑–±—Ä–∞–Ω–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

üëÜ –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ!`;
  
  bot.sendMessage(chatId, welcomeMessage, keyboard);
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /help
bot.onText(/\/help/, (msg) => {
  const chatId = msg.chat.id;
  
  const helpMessage = `ü§ñ **–°–ø—Ä–∞–≤–∫–∞ –ø–æ –±–æ—Ç—É Sales Training**

üìã **–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:**
/start - –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –∏ –ø–æ–∫–∞–∑–∞—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
/help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É
/info - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ
/stats - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (—Å–∫–æ—Ä–æ)

üîß **–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:**
1Ô∏è‚É£ –ù–∞–∂–º–∏—Ç–µ "üåê –û—Ç–∫—Ä—ã—Ç—å –æ–±—É—á–∞—é—â—É—é –ø–ª–∞—Ç—Ñ–æ—Ä–º—É"
2Ô∏è‚É£ –ò–∑—É—á–∞–π—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –≤ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
3Ô∏è‚É£ –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Å–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å
4Ô∏è‚É£ –î–æ–±–∞–≤–ª—è–π—Ç–µ —É—Ä–æ–∫–∏ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ

üí° **–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:**
‚Ä¢ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —É—Ä–æ–∫–æ–≤ (–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏, –í–æ–∑—Ä–∞–∂–µ–Ω–∏—è, –∏ –¥—Ä.)
‚Ä¢ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
‚Ä¢ –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
‚Ä¢ –ò–∑–±—Ä–∞–Ω–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

‚ùì –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.`;
  
  bot.sendMessage(chatId, helpMessage, { parse_mode: 'Markdown' });
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /info
bot.onText(/\/info/, (msg) => {
  const chatId = msg.chat.id;
  
  const infoMessage = `üìä **–û –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ Sales Training**

üéØ **–¶–µ–ª—å:** –û–±—É—á–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º —Ç–µ—Ö–Ω–∏–∫–∞–º –ø—Ä–æ–¥–∞–∂

üìö **–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:**
‚Ä¢ **–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏** - –í—ã—è–≤–ª–µ–Ω–∏–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π –∫–ª–∏–µ–Ω—Ç–∞
‚Ä¢ **–í–æ–∑—Ä–∞–∂–µ–Ω–∏—è** - –†–∞–±–æ—Ç–∞ —Å –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è–º–∏
‚Ä¢ **–ü–æ—Å—Ç–º–∏—Ç–∏–Ω–≥** - –†–∞–±–æ—Ç–∞ –ø–æ—Å–ª–µ –≤—Å—Ç—Ä–µ—á–∏  
‚Ä¢ **–ó–∞–∫—Ä—ã—Ç–∏–µ** - –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–¥–µ–ª–∫–∏

‚ö° **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
‚Ä¢ –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
‚Ä¢ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω
‚Ä¢ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
‚Ä¢ –°–∏—Å—Ç–µ–º–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ

üîó **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:** Next.js, React, Supabase, Telegram Bot API

–í–µ—Ä—Å–∏—è: 1.0.0`;
  
  bot.sendMessage(chatId, infoMessage, { parse_mode: 'Markdown' });
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
bot.on('message', (msg) => {
  // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã –∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  if (msg.text && !msg.text.startsWith('/') && !msg.web_app_data) {
    const chatId = msg.chat.id;
    
    bot.sendMessage(
      chatId,
      '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –æ–±—É—á–∞—é—â–µ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ:',
      {
        reply_markup: {
          keyboard: [
            [{
              text: 'üåê –û—Ç–∫—Ä—ã—Ç—å –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ',
              web_app: { url: process.env.WEBAPP_URL }
            }]
          ],
          resize_keyboard: true
        }
      }
    );
  }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö, –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –∏–∑ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
bot.on('web_app_data', (msg) => {
  const chatId = msg.chat.id;
  const data = msg.web_app_data.data;
  
  try {
    // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ JSON
    const parsedData = JSON.parse(data);
    bot.sendMessage(chatId, `–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: ${JSON.stringify(parsedData, null, 2)}`);
  } catch (e) {
    // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ JSON, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç
    bot.sendMessage(chatId, `–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: ${data}`);
  }
});

console.log('–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω! –ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.');