# Настройка Supabase для приложения Sales Training

## Шаг 1: Создание проекта в Supabase

1. Перейдите на [supabase.com](https://supabase.com)
2. Войдите в аккаунт или зарегистрируйтесь
3. Нажмите "New Project"
4. Выберите организацию и введите:
   - **Name**: Sales Training App
   - **Database Password**: создайте надежный пароль
   - **Region**: выберите ближайший регион
5. Нажмите "Create new project"

## Шаг 2: Получение переменных окружения

После создания проекта перейдите в **Settings > API**:

1. **Project URL** - скопируйте URL проекта
2. **Project API keys**:
   - `anon public` - публичный ключ для клиентской части
   - `service_role` - секретный ключ для серверных операций

## Шаг 3: Настройка переменных окружения

Обновите файл `.env.local` в корне проекта:

```env
# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL=https://your-project-ref.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key-here
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key-here

# Database Connection (для прямого подключения, если нужно)
DATABASE_URL=postgresql://postgres:[YOUR-PASSWORD]@db.your-project-ref.supabase.co:5432/postgres

# NextAuth Configuration (если используется)
NEXTAUTH_SECRET=your-nextauth-secret-here
NEXTAUTH_URL=http://localhost:3000
```

## Шаг 4: Создание схемы базы данных

1. Перейдите в **SQL Editor** в панели Supabase
2. Скопируйте содержимое файла `supabase-schema.sql`
3. Вставьте в SQL Editor и нажмите "Run"

Этот скрипт создаст:
- Таблицы: `users`, `lesson_categories`, `lessons`, `user_progress`
- Индексы для оптимизации запросов
- RLS (Row Level Security) политики
- Триггеры для автоматического обновления timestamps
- Функцию для автоматического создания пользователей

## Шаг 5: Добавление тестовых данных

1. В **SQL Editor** выполните содержимое файла `supabase-sample-data.sql`
2. Это добавит:
   - 4 категории уроков
   - 7 уроков с различным статусом публикации
   - Примеры данных для тестирования

## Шаг 6: Настройка аутентификации

1. Перейдите в **Authentication > Settings**
2. Настройте **Site URL**: `http://localhost:3000` (для разработки)
3. В **Redirect URLs** добавьте: `http://localhost:3000/auth/callback`
4. Включите нужные провайдеры аутентификации (Email, Google, etc.)

## Шаг 7: Настройка Storage (если нужно для аватаров)

1. Перейдите в **Storage**
2. Создайте bucket с именем `avatars`
3. Настройте политики доступа для загрузки аватаров

## Шаг 8: Проверка подключения

1. Перезапустите сервер разработки: `npm run dev`
2. Откройте приложение в браузере
3. Проверьте, что:
   - Категории загружаются корректно
   - Уроки отображаются в категориях
   - Нет ошибок 500 в консоли

## Структура базы данных

### Таблицы:

1. **users** - профили пользователей
   - Связана с `auth.users` через внешний ключ
   - Содержит роли и дополнительную информацию

2. **lesson_categories** - категории уроков
   - Поддерживает порядок сортировки
   - Статус публикации

3. **lessons** - уроки
   - Связаны с категориями
   - Поддерживают типы: sprint/archive
   - Статус публикации

4. **user_progress** - прогресс пользователей
   - Отслеживает статус прохождения
   - Избранные уроки
   - Время изучения

### Представления:

- **categories_with_counts** - категории с подсчетом уроков

## Безопасность

Настроены RLS политики:
- Пользователи видят только свои данные
- Публичный доступ к опубликованным урокам
- Админы имеют полный доступ

## Troubleshooting

### Ошибка подключения:
- Проверьте правильность URL и ключей в `.env.local`
- Убедитесь, что проект активен в Supabase

### Ошибки RLS:
- Проверьте, что пользователь аутентифицирован
- Убедитесь, что политики настроены корректно

### Проблемы с данными:
- Проверьте, что схема создана корректно
- Убедитесь, что тестовые данные загружены

## Дополнительные возможности

После базовой настройки можно добавить:
- Realtime подписки для обновлений в реальном времени
- Edge Functions для сложной бизнес-логики
- Webhooks для интеграций
- Backup и миграции